--1) Consultar o nome, rg e cidade do endereço principal (primeiro endereço) de todos os usuários da biblioteca  
--e, caso possua multas cadastradas com 3 ou mais dias de atraso, mostrar os dias de atraso para cada uma, 
--o titulo do livro emprestado, o valor da multa e a data de pagamento, com os dados mostrados em ordem 
--alfabética pelo nome da cidade. Caso não possua multas, deverá exibir a frase "Não possui" nos campos 
--referentes a multa.
--Funcionamento: A consulta envolve as tabelas usuario, endereco_usuario, multa, emprestimo, exemplar e 
--livro, com WITH AS para a subconsulta dos usuarios com multa, INNER JOIN e LEFT JOIN para as junções e uso
--de COALESE em dados para quando não existam multas com mais de 3 dias de atraso para o usuário, além de 
--ORDER BY para a ordenação.

WITH um AS 
    (SELECT u.codigo_usuario, m.dias_atraso, l.titulo, m.valor, m.data_pagamento
    FROM usuario u
    JOIN endereco_usuario eu ON eu.codigo_usuario = u.codigo_usuario AND codigo_endereco_usuario = 1
    JOIN emprestimo e ON e.codigo_usuario = u.codigo_usuario
    JOIN multa m ON m.codigo_emprestimo = e.codigo_emprestimo AND m.dias_atraso >= 3
    LEFT JOIN devolucao d ON d.codigo_emprestimo = e.codigo_emprestimo
    LEFT JOIN exemplar ex ON ex.codigo_exemplar = e.codigo_exemplar
    LEFT JOIN livro l ON l.isbn = ex.isbn
    WHERE m.dias_atraso >= 3)
    
SELECT u.nome, u.rg, eu.cidade, COALESCE(um.dias_atraso::text, 'Não possui') AS dias_atraso, 
COALESCE(um.titulo, 'Não possui') AS titulo, COALESCE(um.valor::text, 'Não possui') AS valor, 
COALESCE(um.data_pagamento::text, 'Não possui') AS data_pagamento
FROM usuario u
JOIN endereco_usuario eu ON eu.codigo_usuario = u.codigo_usuario AND codigo_endereco_usuario = 1
LEFT JOIN um ON um.codigo_usuario = u.codigo_usuario
ORDER BY eu.cidade;