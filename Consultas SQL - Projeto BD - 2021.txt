/*1) Consultar o nome, rg e cidade do endereço principal (primeiro endereço) de todos os usuários da biblioteca  
e, caso possua multas cadastradas com 3 ou mais dias de atraso, mostrar os dias de atraso para cada uma, 
o titulo do livro emprestado, o valor da multa e a data de pagamento, com os dados mostrados em ordem 
alfabética pelo nome da cidade. Caso não possua multas, deverá exibir a frase "Não possui" nos campos 
referentes a multa.
Funcionamento: A consulta envolve as tabelas usuario, endereco_usuario, multa, emprestimo, exemplar e 
livro, com WITH AS para a subconsulta dos usuarios com multa, INNER JOIN e LEFT JOIN para as junções e uso
de COALESE em dados para quando não existam multas com mais de 3 dias de atraso para o usuário, além de 
ORDER BY para a ordenação.*/

WITH um AS 
    (SELECT u.codigo_usuario, m.dias_atraso, l.titulo, m.valor, m.data_pagamento
    FROM usuario u
    JOIN emprestimo e ON e.codigo_usuario = u.codigo_usuario
    JOIN multa m ON m.codigo_emprestimo = e.codigo_emprestimo AND m.dias_atraso >= 3
    LEFT JOIN devolucao d ON d.codigo_emprestimo = e.codigo_emprestimo
    LEFT JOIN exemplar ex ON ex.codigo_exemplar = e.codigo_exemplar
    LEFT JOIN livro l ON l.isbn = ex.isbn
    WHERE m.dias_atraso >= 3)
    
SELECT u.nome, u.rg, eu.cidade, COALESCE(um.dias_atraso::text, 'Não possui') AS dias_atraso, 
COALESCE(um.titulo, 'Não possui') AS titulo, COALESCE(um.valor::text, 'Não possui') AS valor, 
COALESCE(um.data_pagamento::text, 'Não possui') AS data_pagamento
FROM usuario u
JOIN endereco_usuario eu ON eu.codigo_usuario = u.codigo_usuario AND codigo_endereco_usuario = 1
LEFT JOIN um ON um.codigo_usuario = u.codigo_usuario
ORDER BY eu.cidade;


/*2) Consultar o nome, rg, telefone principal (primeiro telefone) e cidade do endereço principal (primeiro 
endereço) de todos os bibliotecários, assim como o número de empréstimos que já efetuaram e de 
devoluções e multas que já receberam, com os valores mostrados em ordem decrescente pelo número de emprestimos 
efetuados.
Funcionamento: A consulta envolve as tabelas bibliotecario, endereco_bibliotecario, multa, emprestimo e 
devolucao, com INNER JOIN e FULL JOIN, GROUP BY, COUNT para os totais, COALESE para dados nulos 
e ORDER BY para a ordenação.*/

WITH be AS
    (SELECT e.codigo_bibliotecario, count(e.codigo_bibliotecario)
     FROM bibliotecario b
     JOIN emprestimo e ON e.codigo_bibliotecario = b.codigo_bibliotecario
     GROUP BY (e.codigo_bibliotecario)
    ),
bm AS
    (SELECT m.codigo_bibliotecario, count(m.codigo_bibliotecario)
     FROM bibliotecario b
     JOIN emprestimo e ON e.codigo_bibliotecario = b.codigo_bibliotecario
     JOIN multa m ON m.codigo_emprestimo = e.codigo_emprestimo
     GROUP BY (m.codigo_bibliotecario)
    ),
bd AS
    (SELECT d.codigo_bibliotecario, count(d.codigo_bibliotecario)
     FROM bibliotecario b
     JOIN emprestimo e ON e.codigo_bibliotecario = b.codigo_bibliotecario
     JOIN devolucao d ON d.codigo_emprestimo = e.codigo_emprestimo
     GROUP BY (d.codigo_bibliotecario)
    )

SELECT b.nome, b.rg, b.telefone[1], eb.cidade, COALESCE(be.count, 0) AS emprestimos, 
    COALESCE(bd.count, 0) AS devolucoes, COALESCE(bm.count, 0) AS multas
FROM bibliotecario b
JOIN endereco_bibliotecario eb ON eb.codigo_bibliotecario = b.codigo_bibliotecario 
    AND eb.codigo_endereco_bibliotecario = 1
JOIN be ON be.codigo_bibliotecario = b.codigo_bibliotecario
LEFT JOIN bm ON bm.codigo_bibliotecario = b.codigo_bibliotecario
LEFT JOIN bd ON bd.codigo_bibliotecario = b.codigo_bibliotecario
ORDER BY emprestimos DESC;


/*3) Consultar o título e nome do autor de cada livro, assim como o número total de exemplares disponíveis e 
o total de empréstimos realizados, com os valores mostrados em ordem decrescente pelo total de exemplares. 
Funcionamento: A consulta envolve as tabelas livro, exemplar, autor e empréstimo, com uso de INNER JOIN, 
WITH para as subconsultas, GROUP BY para obter os totais e COALESCE para o caso de falta de empréstimos.*/

WITH tex AS 
    (SELECT e.isbn, COUNT(e.isbn)
     FROM exemplar e
     GROUP BY (e.isbn)),
tem AS
    (SELECT ex.isbn, COUNT(ex.isbn)
     FROM exemplar ex
     JOIN emprestimo em ON em.codigo_exemplar = ex.codigo_exemplar
     GROUP BY (ex.isbn))
SELECT l.titulo, a.nome, COALESCE(tex.count, 0) AS total_exemplares, COALESCE(tem.count, 0) AS total_emprestimos
FROM livro l
JOIN autor a ON a.codigo_autor = l.codigo_autor
LEFT JOIN tex ON tex.isbn = l.isbn
LEFT JOIN tem ON tem.isbn = l.isbn
ORDER BY total_exemplares DESC;


/*4) Encontrar o nome de todos os livros e, para cada um, mostrar a data de empréstimo de seu exemplar que 
resultou na multa de maior valor de atraso, assim como o nome do usuário que efetuou o empréstimo e o valor 
da multa, em ordem alfabética pelo nome do usuário. Caso não haja multas para o livro, exibir a frase "Sem
multas" nos campos referente a multa.
Funcionamento: A consulta envolve as tabelas livro, exemplar, emprestimo, multa e usuario, envolvendo o uso 
de INNER JOIN e FULL JOIN, além das funções WITH() e MAX() para a obtenção dos maiores valores e ORDER BY 
para a ordenação.*/

WITH mv AS 
    (SELECT l.isbn, MAX(m.valor) AS valor
    FROM livro l
    JOIN exemplar ex ON ex.isbn = l.isbn
    JOIN emprestimo em ON em.codigo_exemplar = ex.codigo_exemplar
    JOIN multa m ON m.codigo_emprestimo = em.codigo_emprestimo
    GROUP BY (l.isbn)),
emv AS
    (SELECT l.isbn, em.data_emprestimo, u.nome, m.valor
    FROM livro l
    LEFT JOIN mv ON mv.isbn = l.isbn
    LEFT JOIN exemplar ex ON ex.isbn = l.isbn
    LEFT JOIN emprestimo em ON em.codigo_exemplar = ex.codigo_exemplar
    LEFT JOIN multa m ON m.codigo_emprestimo = em.codigo_emprestimo
    LEFT JOIN usuario u ON u.codigo_usuario = em.codigo_usuario
    WHERE m.valor=mv.valor)

SELECT l.titulo, COALESCE(emv.data_emprestimo::text, 'Sem multas') AS data_emprestimo, 
COALESCE(emv.nome, 'Sem multas') AS nome_usuario, COALESCE(emv.valor::text, 'Sem multas') AS valor_multa
FROM livro l
LEFT JOIN emv ON emv.isbn = l.isbn
ORDER BY nome_usuario;



